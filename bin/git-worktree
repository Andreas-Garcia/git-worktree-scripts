#!/bin/bash

# Main git-worktree command that handles subcommands
# Usage: git-worktree <subcommand> [args...]

# Get the actual script location, resolving symlinks
SCRIPT_PATH="${BASH_SOURCE[0]}"
# Resolve symlinks to get the real path
if [ -L "$SCRIPT_PATH" ]; then
    SCRIPT_PATH="$(readlink -f "$SCRIPT_PATH" 2>/dev/null || readlink "$SCRIPT_PATH" 2>/dev/null || echo "$SCRIPT_PATH")"
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
# Find the package root (where package.json is)
REPO_ROOT="$SCRIPT_DIR"
while [ ! -f "$REPO_ROOT/package.json" ] && [ "$REPO_ROOT" != "/" ]; do
    REPO_ROOT="$(cd "$REPO_ROOT/.." && pwd)"
done
# If we couldn't find package.json, fall back to one level up from script dir
if [ ! -f "$REPO_ROOT/package.json" ]; then
    REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
fi

SUBCOMMAND="${1:-}"

# Handle help flags
if [ "$SUBCOMMAND" = "--help" ] || [ "$SUBCOMMAND" = "-h" ] || [ "$SUBCOMMAND" = "help" ]; then
    echo "Usage: git-worktree <command> [args...]"
    echo ""
    echo "Commands:"
    echo "  create <branch-name> [worktree-name]  Create a new worktree"
    echo "  open                                  Open an existing worktree"
    echo "  remove [branch-name]                  Remove a worktree (interactive if no branch specified)"
    echo "  rm [branch-name]                      Alias for remove"
    echo ""
    echo "Examples:"
    echo "  git-worktree create feature/my-feature"
    echo "  git-worktree open"
    echo "  git-worktree remove"
    echo "  git-worktree remove feature/my-feature"
    echo ""
    echo "For more information, visit: https://github.com/Andreas-Garcia/git-worktree-scripts"
    exit 0
fi

case "$SUBCOMMAND" in
    create)
        shift
        exec "$REPO_ROOT/scripts/create-worktree.sh" "$@"
        ;;
    open)
        shift
        exec "$REPO_ROOT/scripts/open-worktree.sh" "$@"
        ;;
    remove|rm)
        shift
        # Check if next arg looks like a branch name (no dash prefix)
        if [ $# -gt 0 ] && [[ ! "$1" =~ ^- ]]; then
            exec "$REPO_ROOT/scripts/remove-worktree-branch.sh" "$@"
        else
            exec "$REPO_ROOT/scripts/remove-worktree-interactive.sh" "$@"
        fi
        ;;
    *)
        if [ -z "$SUBCOMMAND" ]; then
            echo "Usage: git-worktree <command> [args...]"
            echo ""
            echo "Commands:"
            echo "  create <branch-name> [worktree-name]  Create a new worktree"
            echo "  open                                  Open an existing worktree"
            echo "  remove [branch-name]                  Remove a worktree (interactive if no branch specified)"
            echo "  rm [branch-name]                      Alias for remove"
            echo ""
            echo "Examples:"
            echo "  git-worktree create feature/my-feature"
            echo "  git-worktree open"
            echo "  git-worktree remove"
            echo "  git-worktree remove feature/my-feature"
            echo ""
            echo "Run 'git-worktree --help' for more information"
            exit 1
        else
            echo "Unknown command: $SUBCOMMAND"
            echo "Run 'git-worktree --help' for usage information"
            exit 1
        fi
        ;;
esac

